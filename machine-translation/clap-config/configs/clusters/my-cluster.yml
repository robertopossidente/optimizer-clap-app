setups:
  setup-initial:
    roles:
    - name: gan
    actions:
    - role: gan
      action: update-packages

  setup-packages:
    actions:
    - role: gan
      action: install-packages
      extra:
        packages: python3-pip, build-essential, cmake, openmpi-bin, openmpi-common, openmpi-doc, libopenmpi-dev

  setup-commands:
    actions:
    - role: gan
      action: run-command
      extra:
        cmd: sudo apt-get -y install python-is-python3
        
  setup-env:
    actions:
    - role: gan
      action: run-command
      extra:
        cmd: pip install mxnet gluonnlp sacremoses 

  setup-horovod:
    actions:
    - role: gan
      action: run-command
      extra:
        cmd: pip install horovod --no-cache-dir 

  setup-git:
    actions:
    - role: gan
      action: run-command
      extra:  
        cmd: git clone https://github.com/robertopossidente/optimizer-clap-app.git

  setup-facts:
    actions:
    - role: gan
      action: run-command
      extra:
        cmd: sudo mkdir -p /etc/ansible/facts.d/ && sudo touch /etc/ansible/facts.d/times.fact

  setup-ssh:
    actions:
    - role: gan
      action: run-command
      extra:  
        cmd: chmod 400 optimizer-clap-app/machine-translation/clap-config/private/gan-clap-keypair.pem && sudo cp optimizer-clap-app/machine-translation/clap-config/private/gan-clap-keypair.pem /home/ubuntu/.ssh/id_rsa && sudo chown ubuntu:ubuntu /home/ubuntu/.ssh/id_rsa

  run-training: 
    actions:
    - role: gan
      action: run-command
      extra:
        cmd: mpirun -np 1 -H localhost:1 -bind-to none -map-by slot python /home/ubuntu/optimizer-clap-app/machine-translation/my-train.py 2>&1 > log.txt 

clusters:
  my-cluster:
    #options:
    #  ssh_to: jobmanager

    nodes:
      jobmanager:
        type: type-a
        count: 1
        setups:
        - setup-initial

      taskmanager:
        type: type-a
        count: 1
        min_count: 1
        setups:
        - setup-initial
      
      #taskmanager:
      #  type: type-a
      #  count: 1
      #  min_count: 1
      #  setups:
      #  - setup-initial

    after:
    - setup-packages
    - setup-commands
    - setup-env
    - setup-horovod
    - setup-git
    - setup-facts
    - setup-ssh
    - run-training